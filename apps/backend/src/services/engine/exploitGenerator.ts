
import { AIServiceFactory } from '../ai/factory';
import { PromptManager } from '@bugbounty/shared';

export class ExploitGenerator {
    private aiService = AIServiceFactory.createService();

    async generatePayloads(targetContext: string, attackType: string = 'default'): Promise<string[]> {
        const template = PromptManager.getTemplate(attackType);

        const userPrompt = PromptManager.fillTemplate(template.userTemplate, {
            url: 'http://target-placeholder.com', // In real app, this comes from context
            context: targetContext
        });

        try {
            const result = await this.aiService.generateCompletion({
                userPrompt: userPrompt,
                systemPrompt: template.system
            });

            // Parse generic JSON output
            // Expected format: { payloads: [ ... ] } or [ ... ]
            // For resilience, we ask AI to return a specific structure but handle parsing loosely
            const parsed = this.parseAIResponse(result.content);
            return parsed.map((p: any) => p.payload || p.toString());
        } catch (error) {
            console.error('AI Generation Failed:', error);
            return [];
        }
    }

    private parseAIResponse(text: string): any[] {
        try {
            // Find JSON in the response (sometimes AI chats around it)
            const match = text.match(/\[.*\]/s) || text.match(/\{.*\}/s);
            if (match) {
                const json = JSON.parse(match[0]);
                return Array.isArray(json) ? json : (json.payloads || []);
            }
            return [];
        } catch (e) {
            return [];
        }
    }
}
